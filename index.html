<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Fluxo Linear das Salas</title>
    <base target="_top" />
    <style>
      :root {
        --bg: #f7f8fb;
        --ink: #0f172a;
        --muted: #5b6473;
        --panel: #ffffff;
        --border: rgba(15, 23, 42, 0.08);
        --primary: #1f4b99;
        --accent: #3a6bdc;
        --shadow: 0 20px 60px rgba(15, 23, 42, 0.06);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "SF Pro Text", "Inter", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at 18% 18%, #ffffff 0, #f7f8fb 62%),
          linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%);
        color: var(--ink);
        min-height: 100vh;
      }

      .app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 28px 32px 22px;
        gap: 14px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .badge {
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(31, 75, 153, 0.12);
        font-size: 0.82rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--primary);
        border: 1px solid rgba(31, 75, 153, 0.18);
      }

      .titles h1 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .titles p {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .mode-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .mode-indicator {
        padding: 8px 12px;
        border-radius: 10px;
        background: rgba(15, 23, 42, 0.06);
        color: var(--ink);
        font-weight: 600;
        font-size: 0.92rem;
      }

      .ghost-button {
        border: 1px solid rgba(15, 23, 42, 0.1);
        background: #ffffff;
        color: var(--ink);
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 160ms ease;
        box-shadow: var(--shadow);
      }

      .ghost-button:hover {
        transform: translateY(-1px);
      }

      .ghost-button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        flex-wrap: wrap;
      }

      .toolbar button,
      .toolbar .file-label,
      .toolbar select,
      .toolbar .status {
        border: 1px solid var(--border);
        background: #fff;
        color: var(--ink);
        border-radius: 12px;
        padding: 8px 12px;
        font-size: 0.92rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: border-color 0.18s ease, box-shadow 0.2s ease;
      }

      .toolbar button:hover,
      .toolbar .file-label:hover,
      .toolbar select:hover {
        border-color: rgba(31, 75, 153, 0.35);
        box-shadow: var(--shadow);
      }

      .toolbar button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        box-shadow: none;
      }

      .toolbar select {
        appearance: none;
        padding-right: 28px;
        background-image: linear-gradient(45deg, transparent 50%, #1f4b99 50%),
          linear-gradient(135deg, #1f4b99 50%, transparent 50%);
        background-position: calc(100% - 16px) calc(50% - 4px),
          calc(100% - 10px) calc(50% - 4px);
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
      }

      .status {
        cursor: default;
        font-weight: 600;
        color: var(--ink);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-flex;
        background: #22c55e;
      }

      .status.unsaved .status-dot {
        background: #f59e0b;
      }

      .status.saving .status-dot {
        background: #1f4b99;
      }

      .save-bar {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        height: 3px;
        background: linear-gradient(90deg, rgba(31, 75, 153, 0.28), transparent);
        transform-origin: left;
        scale: 0;
        transition: scale 0.25s ease;
      }

      .save-bar.active {
        scale: 1;
        animation: progress 1.4s linear infinite;
      }

      @keyframes progress {
        from {
          transform: translateX(-20%);
        }
        to {
          transform: translateX(20%);
        }
      }

      .viewport {
        position: relative;
        flex: 1;
        margin: 6px 0 8px;
        border-radius: 20px;
        overflow: hidden;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.92) 0%,
            rgba(244, 245, 248, 0.95) 100%);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 24px 20px 32px 32px;
      }

      .linear-flow {
        position: relative;
        max-width: 920px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .flow-line {
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, rgba(31, 75, 153, 0.16), rgba(58, 107, 220, 0.32));
        border-radius: 999px;
      }

      .step {
        position: relative;
        padding-left: 60px;
      }

      .step::before {
        content: attr(data-index);
        position: absolute;
        left: 0;
        top: 18px;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: rgba(31, 75, 153, 0.1);
        border: 1px solid rgba(31, 75, 153, 0.28);
        display: grid;
        place-items: center;
        font-weight: 700;
        color: var(--primary);
      }

      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px 16px 12px;
        box-shadow: var(--shadow);
        transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.12s ease;
      }

      .card.selected {
        border-color: rgba(31, 75, 153, 0.35);
        box-shadow: 0 26px 70px rgba(31, 75, 153, 0.15);
        transform: translateY(-1px);
      }

      .step[data-depth="0"] .card {
        background: linear-gradient(135deg, rgba(31, 75, 153, 0.08), rgba(31, 75, 153, 0.01));
      }

      .node-title {
        font-size: 1.08rem;
        font-weight: 700;
        letter-spacing: -0.01em;
        margin: 0 0 6px;
        outline: none;
      }

      .node-meta {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
        line-height: 1.4;
        outline: none;
      }

      .node.read-only .node-title,
      .node.read-only .node-meta {
        cursor: default;
      }

      .node-tags {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 8px 0;
      }

      .tag {
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 0.78rem;
        background: rgba(31, 75, 153, 0.08);
        border: 1px solid rgba(31, 75, 153, 0.12);
        color: var(--ink);
      }

      .node-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .chip-button {
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.03);
        color: var(--ink);
        border-radius: 10px;
        padding: 6px 10px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: opacity 0.15s ease, border-color 0.2s ease;
      }

      .chip-button:hover {
        border-color: rgba(31, 75, 153, 0.3);
        opacity: 1;
      }

      .collapsed-hint {
        font-size: 0.82rem;
        color: var(--muted);
        background: rgba(15, 23, 42, 0.04);
        border: 1px dashed var(--border);
        border-radius: 10px;
        padding: 6px 8px;
        margin-top: 8px;
      }

      .floating-card {
        position: absolute;
        top: 18px;
        right: 18px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        display: grid;
        gap: 6px;
        min-width: 240px;
        color: var(--ink);
      }

      .floating-card h3 {
        margin: 0;
        font-size: 0.98rem;
      }

      .floating-card small {
        color: var(--muted);
      }

      .history {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .history span {
        background: rgba(15, 23, 42, 0.04);
        border: 1px solid var(--border);
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.78rem;
        color: var(--muted);
      }

      .save-progress {
        width: 120px;
        height: 8px;
        background: rgba(15, 23, 42, 0.04);
        border: 1px solid var(--border);
        border-radius: 999px;
        position: relative;
        overflow: hidden;
        display: none;
      }

      .save-progress.active {
        display: block;
      }

      .save-progress span {
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        transform-origin: left;
        transform: scaleX(0);
        transition: transform 0.25s ease;
      }

      .toast {
        position: fixed;
        bottom: 18px;
        right: 18px;
        padding: 11px 14px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.92);
        color: #f8fbff;
        box-shadow: var(--shadow);
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        font-size: 0.9rem;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div class="header-left">
          <span class="badge">Fluxo Linear</span>
          <div class="titles">
            <h1>Mapa das Salas</h1>
            <p>Visualização sequencial das salas cadastradas</p>
          </div>
        </div>
        <div class="mode-controls">
          <span class="mode-indicator" id="modeIndicator">Modo: Explorar</span>
          <button class="ghost-button" id="modeToggle">Entrar em edição</button>
        </div>
      </header>

      <div class="toolbar">
        <button id="btnAddChild">Adicionar filho</button>
        <button id="btnAddSibling">Adicionar irmão</button>
        <button id="btnDelete">Remover</button>
        <button id="btnCollapse">Colapsar/expandir</button>
        <button id="btnUndo">Desfazer</button>
        <button id="btnRedo">Refazer</button>
        <button id="btnSave">Salvar</button>
        <button id="btnExport">Exportar JSON</button>
        <label class="file-label" for="fileImport">Importar JSON</label>
        <input id="fileImport" type="file" accept="application/json" hidden />
        <select id="versionSelector"></select>
        <span class="status" id="syncStatus">
          <span class="status-dot"></span>
          <strong>Sincronizado</strong>
        </span>
        <div class="save-progress" id="saveProgress">
          <span id="saveProgressBar"></span>
        </div>
      </div>

      <div class="viewport" id="viewport">
        <div class="save-bar" id="saveBar"></div>
        <div class="linear-flow" id="linearFlow">
          <div class="flow-line"></div>
        </div>
        <div class="floating-card">
          <h3>Histórico rápido</h3>
          <small>Mudanças recentes</small>
          <div class="history" id="historyList"></div>
        </div>
      </div>

      <div class="toast" id="toast">Ação concluída</div>
    </div>

    <script>
      const linearFlow = document.getElementById("linearFlow");
      const toast = document.getElementById("toast");
      const syncStatus = document.getElementById("syncStatus");
      const saveBar = document.getElementById("saveBar");
      const saveProgressBar = document.getElementById("saveProgressBar");
      const saveProgress = document.getElementById("saveProgress");
      const historyList = document.getElementById("historyList");
      const modeIndicator = document.getElementById("modeIndicator");
      const modeToggle = document.getElementById("modeToggle");
      const btnAddChild = document.getElementById("btnAddChild");
      const btnAddSibling = document.getElementById("btnAddSibling");
      const btnDelete = document.getElementById("btnDelete");
      const btnCollapse = document.getElementById("btnCollapse");
      const btnUndo = document.getElementById("btnUndo");
      const btnRedo = document.getElementById("btnRedo");
      const btnSave = document.getElementById("btnSave");
      const btnExport = document.getElementById("btnExport");
      const fileImport = document.getElementById("fileImport");
      const versionSelector = document.getElementById("versionSelector");

      let mapState = { nodes: [], rootId: null };
      let selectedId = null;
      let editMode = false;
      let undoStack = [];
      let redoStack = [];
      let historyLog = [];
      let savePending = false;
      let saveInFlight = false;
      let saveTimer = null;
      const nodeElements = new Map();

      function defaultMap() {
        const rootId = crypto.randomUUID();
        const salas = [
          {
            title: "Recepção",
            description: "Acolhimento e registros",
            color: "#38bdf8",
          },
          {
            title: "Triagem",
            description: "Avaliação inicial de pacientes",
            color: "#c084fc",
          },
          {
            title: "Sala Amarela",
            description: "Cuidados intermediários",
            color: "#f59e0b",
          },
          {
            title: "Sala Vermelha",
            description: "Emergências críticas",
            color: "#ef4444",
          },
          {
            title: "Centro Cirúrgico",
            description: "Procedimentos cirúrgicos",
            color: "#22c55e",
          },
          {
            title: "UTI",
            description: "Cuidados intensivos",
            color: "#3b82f6",
          },
        ];

        return {
          rootId,
          nodes: [
            {
              id: rootId,
              parentId: null,
              title: "Hospital Estadual",
              description: "Mapa linear das salas cadastradas",
              tags: ["hospital", "dashboard"],
              collapsed: false,
              position: { x: 0, y: 0 },
              color: "#60a5fa",
            },
            ...salas.map((sala, idx) => ({
              id: crypto.randomUUID(),
              parentId: rootId,
              title: sala.title,
              description: sala.description,
              tags: ["sala"],
              collapsed: false,
              position: { x: 0, y: 0 },
              color: sala.color,
              order: idx + 1,
            })),
          ],
        };
      }

      function showToast(message) {
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2200);
      }

      function setStatus(unsaved, saving = false) {
        savePending = unsaved;
        saveInFlight = saving;
        const dot = syncStatus.querySelector(".status-dot");
        const label = syncStatus.querySelector("strong");
        syncStatus.classList.toggle("unsaved", unsaved && !saving);
        syncStatus.classList.toggle("saving", saving);
        saveBar.classList.toggle("active", saving);
        saveProgress.classList.toggle("active", unsaved || saving);
        if (saving) {
          dot.style.boxShadow = "0 0 0 6px rgba(79,139,255,0.15)";
          label.textContent = "Salvando...";
          saveProgressBar.style.transform = "scaleX(1)";
        } else if (unsaved) {
          dot.style.boxShadow = "0 0 0 6px rgba(248,184,74,0.15)";
          label.textContent = "Alterações pendentes";
          saveProgressBar.style.transform = "scaleX(0.6)";
        } else {
          dot.style.boxShadow = "0 0 0 6px rgba(50,213,131,0.15)";
          label.textContent = "Sincronizado";
          saveProgressBar.style.transform = "scaleX(0)";
        }
      }

      function setMode(isEdit) {
        editMode = isEdit;
        document.body.classList.toggle("edit-mode", editMode);
        modeIndicator.textContent = editMode ? "Modo: Editar" : "Modo: Explorar";
        modeToggle.textContent = editMode
          ? "Voltar a explorar"
          : "Entrar em edição";

        [
          btnAddChild,
          btnAddSibling,
          btnDelete,
          btnCollapse,
          btnUndo,
          btnRedo,
          btnSave,
          btnExport,
          fileImport,
          versionSelector,
        ].forEach((el) => {
          if (!el) return;
          el.disabled = !editMode;
        });

        render();
      }

      function requireEdit(action = "editar") {
        if (editMode) return true;
        showToast(`Ative o modo editar para ${action}.`);
        return false;
      }

      function pushHistory(label = "alteração") {
        undoStack.push(JSON.stringify(mapState));
        historyLog.unshift(`${new Date().toLocaleTimeString()} · ${label}`);
        if (undoStack.length > 60) undoStack.shift();
        if (historyLog.length > 10) historyLog.pop();
        redoStack.length = 0;
        renderHistory();
      }

      function renderHistory() {
        historyList.innerHTML = historyLog
          .map((item) => `<span>${item}</span>`)
          .join("");
      }

      function loadFromServer() {
        if (typeof google !== "undefined" && google.script) {
          google.script.run
            .withSuccessHandler((data) => {
              mapState = data && data.nodes ? data : defaultMap();
              selectedId = mapState.rootId;
              render();
              setStatus(false, false);
              loadVersions();
            })
            .withFailureHandler(() => {
              mapState = defaultMap();
              selectedId = mapState.rootId;
              render();
              setStatus(false, false);
              loadVersions();
            })
            .getMap();
        } else {
          mapState = defaultMap();
          selectedId = mapState.rootId;
          render();
          setStatus(false, false);
          loadVersions();
        }
      }

      function persistVersion() {
        const versions = JSON.parse(localStorage.getItem("mapVersions") || "[]");
        versions.unshift({
          savedAt: new Date().toISOString(),
          data: mapState,
        });
        if (versions.length > 8) versions.pop();
        localStorage.setItem("mapVersions", JSON.stringify(versions));
        loadVersions();
      }

      function loadVersions() {
        const versions = JSON.parse(localStorage.getItem("mapVersions") || "[]");
        versionSelector.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Versões locais";
        versionSelector.appendChild(opt);
        versions.forEach((v, idx) => {
          const option = document.createElement("option");
          const date = new Date(v.savedAt);
          option.value = idx;
          option.textContent = `${idx + 1} • ${date.toLocaleString()}`;
          versionSelector.appendChild(option);
        });
      }

      function saveToServer(debounced = true) {
        setStatus(true, true);
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          if (typeof google !== "undefined" && google.script) {
            google.script.run
              .withSuccessHandler(() => {
                setStatus(false, false);
                showToast("Mapa salvo na planilha");
                persistVersion();
              })
              .withFailureHandler(() => showToast("Falha ao salvar"))
              .setMap(mapState);
          } else {
            setStatus(false, false);
            persistVersion();
          }
        }, debounced ? 350 : 0);
      }

      function validateText(value, max, fallback) {
        const trimmed = (value || "").trim();
        if (!trimmed) return fallback;
        if (trimmed.length > max) {
          showToast(`Limite de ${max} caracteres aplicado.`);
        }
        return trimmed.slice(0, max);
      }

      function buildOrder() {
        const byParent = mapState.nodes.reduce((acc, n) => {
          const key = n.parentId || "root";
          acc[key] = acc[key] || [];
          acc[key].push(n);
          return acc;
        }, {});

        const sequence = [];
        const root = mapState.nodes.find((n) => n.id === mapState.rootId);

        function traverse(node, depth) {
          if (!node) return;
          sequence.push({ node, depth });
          if (node.collapsed) return;
          const children = (byParent[node.id] || []).sort((a, b) =>
            (a.order ?? 0) - (b.order ?? 0)
          );
          children.forEach((child) => traverse(child, depth + 1));
        }

        traverse(root, 0);
        return sequence;
      }

      function render() {
        linearFlow.querySelectorAll(".step").forEach((el) => el.remove());
        nodeElements.clear();
        const order = buildOrder();
        order.forEach(({ node, depth }, idx) => {
          const step = document.createElement("div");
          step.className = "step";
          step.dataset.index = String(idx + 1).padStart(2, "0");
          step.dataset.depth = depth;

          const card = document.createElement("div");
          card.className = "card";
          card.dataset.id = node.id;
          card.style.borderLeft = `6px solid ${node.color || "#1f4b99"}`;
          if (node.id === selectedId) card.classList.add("selected");

          const title = document.createElement("h3");
          title.className = "node-title";
          title.contentEditable = editMode;
          title.textContent = node.title;
          title.addEventListener("input", (e) => {
            node.title = validateText(e.target.textContent, 80, "Sem título");
            setStatus(true, false);
          });

          const meta = document.createElement("p");
          meta.className = "node-meta";
          meta.contentEditable = editMode;
          meta.textContent = node.description;
          meta.addEventListener("input", (e) => {
            node.description = validateText(
              e.target.textContent,
              180,
              "Sem descrição"
            );
            setStatus(true, false);
          });

          const tags = document.createElement("div");
          tags.className = "node-tags";
          (node.tags || []).forEach((tag) => {
            const span = document.createElement("span");
            span.className = "tag";
            span.textContent = tag;
            tags.appendChild(span);
          });

          const actions = document.createElement("div");
          actions.className = "node-actions";

          const btnSelect = document.createElement("button");
          btnSelect.className = "chip-button";
          btnSelect.textContent = "Selecionar";
          btnSelect.addEventListener("click", () => {
            selectedId = node.id;
            render();
          });

          const btnChild = document.createElement("button");
          btnChild.className = "chip-button";
          btnChild.textContent = "+ Filho";
          btnChild.disabled = !editMode;
          btnChild.addEventListener("click", () => addNode(node.id, "novo filho"));

          const btnSibling = document.createElement("button");
          btnSibling.className = "chip-button";
          btnSibling.textContent = "+ Irmão";
          btnSibling.disabled = !editMode;
          btnSibling.addEventListener("click", () => addSibling(node.id));

          actions.append(btnSelect, btnChild, btnSibling);

          card.append(title, meta, tags, actions);

          if (node.collapsed) {
            const hint = document.createElement("div");
            hint.className = "collapsed-hint";
            hint.textContent = "Filhos ocultos";
            card.appendChild(hint);
          }

          card.addEventListener("click", () => {
            selectedId = node.id;
            render();
          });

          step.appendChild(card);
          linearFlow.appendChild(step);
          nodeElements.set(node.id, card);
        });
      }

      function addNode(parentId, label = "novo nó") {
        if (!requireEdit("criar nós")) return;
        if (!parentId) parentId = mapState.rootId;
        pushHistory(label);
        const siblings = mapState.nodes.filter((n) => n.parentId === parentId);
        const newNode = {
          id: crypto.randomUUID(),
          parentId,
          title: "Novo nó",
          description: "Descrição",
          tags: [],
          collapsed: false,
          position: { x: 0, y: 0 },
          color: "#4f8bff",
          order: siblings.length + 1,
        };
        mapState.nodes.push(newNode);
        selectedId = newNode.id;
        render();
        saveToServer();
      }

      function addSibling(nodeId) {
        const node = mapState.nodes.find((n) => n.id === nodeId);
        const parent = node ? node.parentId : mapState.rootId;
        addNode(parent, "novo irmão");
      }

      function deleteNode(nodeId) {
        if (!requireEdit("apagar")) return;
        if (!nodeId || nodeId === mapState.rootId) return;
        pushHistory("excluir");
        const toDelete = new Set([nodeId]);
        let changed = true;
        while (changed) {
          changed = false;
          mapState.nodes.forEach((n) => {
            if (toDelete.has(n.parentId) && !toDelete.has(n.id)) {
              toDelete.add(n.id);
              changed = true;
            }
          });
        }
        mapState.nodes = mapState.nodes.filter((n) => !toDelete.has(n.id));
        selectedId = mapState.rootId;
        render();
        saveToServer();
      }

      function toggleCollapse() {
        if (!requireEdit("colapsar")) return;
        const node = mapState.nodes.find((n) => n.id === selectedId);
        if (!node) return;
        pushHistory("colapsar/expandir");
        node.collapsed = !node.collapsed;
        render();
        saveToServer();
      }

      function addChildShortcut() {
        if (!requireEdit("criar filhos")) return;
        const target = selectedId || mapState.rootId;
        addNode(target, "novo filho");
      }

      function addSiblingShortcut() {
        if (!requireEdit("criar irmãos")) return;
        addSibling(selectedId || mapState.rootId);
      }

      function handleUndo() {
        if (!requireEdit("desfazer")) return;
        if (!undoStack.length) return;
        const last = undoStack.pop();
        redoStack.push(JSON.stringify(mapState));
        mapState = JSON.parse(last);
        selectedId = mapState.rootId;
        render();
      }

      function handleRedo() {
        if (!requireEdit("refazer")) return;
        if (!redoStack.length) return;
        undoStack.push(JSON.stringify(mapState));
        mapState = JSON.parse(redoStack.pop());
        selectedId = mapState.rootId;
        render();
      }

      function handleSave() {
        if (!requireEdit("salvar")) return;
        saveToServer(false);
      }

      function setupHotkeys() {
        document.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && e.shiftKey) {
            e.preventDefault();
            addChildShortcut();
          } else if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "s") {
            e.preventDefault();
            handleSave();
          } else if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "z") {
            e.preventDefault();
            handleUndo();
          } else if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "y") {
            e.preventDefault();
            handleRedo();
          } else if (["ArrowUp", "ArrowDown"].includes(e.key)) {
            e.preventDefault();
            navigateLinear(e.key);
          }
        });
      }

      function navigateLinear(direction) {
        const order = buildOrder();
        const index = order.findIndex(({ node }) => node.id === selectedId);
        if (index === -1) return;
        const nextIndex = direction === "ArrowUp" ? index - 1 : index + 1;
        if (order[nextIndex]) {
          selectedId = order[nextIndex].node.id;
          render();
        }
      }

      function bindButtons() {
        btnAddChild.addEventListener("click", addChildShortcut);
        btnAddSibling.addEventListener("click", addSiblingShortcut);
        btnDelete.addEventListener("click", () => deleteNode(selectedId));
        btnCollapse.addEventListener("click", toggleCollapse);
        btnUndo.addEventListener("click", handleUndo);
        btnRedo.addEventListener("click", handleRedo);
        btnSave.addEventListener("click", handleSave);
        btnExport.addEventListener("click", exportJSON);
        fileImport.addEventListener("change", importJSON);
        versionSelector.addEventListener("change", restoreVersion);
        modeToggle.addEventListener("click", () => setMode(!editMode));
      }

      function exportJSON() {
        const dataStr = JSON.stringify(mapState, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `mapa-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function importJSON(event) {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const parsed = JSON.parse(e.target.result);
            if (!parsed.nodes || !parsed.rootId) throw new Error("Arquivo inválido");
            pushHistory("importar JSON");
            mapState = parsed;
            selectedId = mapState.rootId;
            render();
            saveToServer();
          } catch (err) {
            showToast("Falha ao importar JSON");
          }
        };
        reader.readAsText(file);
        event.target.value = "";
      }

      function restoreVersion(e) {
        const idx = e.target.value;
        if (idx === "") return;
        const versions = JSON.parse(localStorage.getItem("mapVersions") || "[]");
        const version = versions[Number(idx)];
        if (version) {
          pushHistory("restaurar versão");
          mapState = version.data;
          selectedId = mapState.rootId;
          render();
          saveToServer();
        }
      }

      setMode(false);
      loadFromServer();
      setupHotkeys();
      bindButtons();
    </script>
  </body>
</html>
